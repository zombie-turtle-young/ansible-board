------

# Ansible Dashboard - 企业级运维监控平台



## ✨ 核心功能特性 (详细介绍)

本平台集成了多种为简化和集中化服务器管理任务而设计的功能。每个功能都经过精心的设计和打磨，旨在提供极致的用户体验和强大的运维能力。

### 🖥️ **全面的主机管理**

- **批量主机操作**：通过界面化的方式，轻松在资产清单中批量添加、编辑和删除主机，告别手动编辑 inventory 文件的繁琐。
- **分组管理**：支持将主机按用途（如 `webservers`、`databases`）进行逻辑分组。这不仅便于管理，还能在执行 Ansible Playbook 或 Ad-Hoc 命令时进行精确的目标选择。
- **实时连通性检测**：一键触发对所有主机的 `ping` 检测，并通过颜色鲜明的徽章（在线/离线）直观展示结果。后端 API 经过优化，即使部分主机不可达，也不会导致整个检测失败。
- **现代化的详情视图**：采用美观的卡片式布局，清晰展示每台主机的详细信息，包括 IP、用户名、所属组、描述以及密码是否已配置等。详情页还集成了动态状态检测和快捷操作入口（编辑、上传、关机、删除），形成一个闭环的管理工作流。

### 📊 **实时资源监控**

- **实时指标**：通过执行定制的 Ansible Playbook (`resource_monitor.yml`)，实时采集并展示所有在线主机的 CPU、内存、磁盘使用率，让系统健康状况一目了然。
- **系统负载跟踪**：除了基础资源，平台还监控系统平均负载（Load Average），这是判断系统压力和潜在性能瓶颈的关键指标。
- **动态可视化图表**：利用 Chart.js 将枯燥的数字转化为动态的条形图和甜甜圈图，直观地比较不同主机间的资源消耗情况，便于快速发现异常主机。
- **自动刷新**：仪表盘前端通过定时器每 30 秒自动请求一次最新监控数据，确保了信息的时效性，无需用户手动刷新页面。

### 📁 **安全的文件管理**

- **多格式支持**：设计了文件类型白名单，支持上传各类运维常用文件，如文档 (`.txt`, `.pdf`)、脚本 (`.sh`, `.py`)、配置文件 (`.conf`) 以及压缩包 (`.zip`, `.tar.gz`)，同时阻止了潜在的危险文件类型。
- **拖拽式上传**：前端采用原生 JavaScript 实现现代化的拖拽文件上传功能，并能实时显示文件名和大小，极大提升了用户体验。
- **批量目标分发**：利用 Ansible `copy` 模块的强大能力，可将文件一次性安全地分发到单个、多个或所有目标主机，是批量部署配置和脚本的利器。
- **安全与清理机制**：后端在接收到上传文件后，会使用 `werkzeug.utils.secure_filename` 进行文件名清洗，并结合时间戳和哈希生成唯一的、安全的文件名。文件在传输到目标主机后，会立即从服务器的临时目录中删除，确保不占用服务器资源且不留下敏感数据。

### 🔴 **智能远程控制**

- **安全的远程关机**：提供立即或延迟（0-60分钟）关机选项，并可通过强制选项跳过系统的正常关闭流程，适用于各种维护场景。

- **多重安全确认**：为了防止灾难性的误操作，执行关机前系统会弹出多次确认对话框，明确告知用户操作的风险和影响范围。

- **取消关机指令**：如果关机指令设置了延迟，用户可以在倒计时结束前随时发送 `shutdown -c` 命令来取消计划中的关机任务。

- 🆕 智能状态更新与Bug修复

  - **问题**：在早期，立即关机常因 SSH 连接被目标主机快速切断而被系统误判为“失败”。
  - **修复**：通过重构后端逻辑，现在的关机 API 不再仅仅依赖于 Ansible 的最终返回码。它会**智能分析** stdout 和 stderr 的输出，将“Shutdown scheduled”、“rc=0”或“Connection closed”等信息都视为**成功关机的标志**。
  - **效果**：这一修复确保了即使用户执行立即关机，前端也能收到准确的成功反馈，提升了系统的可靠性和用户信任度。
  
- **🆕 强化的视觉反馈**：关机指令发送后，前端界面会立即进入**监控模式**。目标主机行会以**橙红色高亮**并附带**脉冲和扫描动画**，直观传达“正在关机并监控中”的状态。当主机确认离线后，该行会变为**绿色**以示成功，整个过程无需人工干预。

## 🔧 技术架构

本平台采用了一套现代化且坚固的技术栈构建：

| **领域** | **技术**                                                     |
| -------- | ------------------------------------------------------------ |
| **后端** | **Python (Flask)**, **Ansible**, **JWT** (用于认证), **多线程** |
| **前端** | **原生 JavaScript (ES6+)**, **Chart.js** (用于图表), **FontAwesome** (用于图标), **CSS3** (用于样式和动画) |
| **部署** | **Docker** & **Docker Compose** (用于一键部署), Nginx (作为反向代理) |

## 📂 项目结构 (详细解释)

项目的目录结构清晰，职责分明，便于维护和二次开发。

```
ansible-dashboard/
├── backend/                 # 核心后端代码目录
│   ├── app.py              # Flask 应用主文件，负责定义所有 API 路由、业务逻辑和与前端的交互。
│   ├── utils/              # 后端工具模块
│   │   ├── ansible_runner.py # 封装了 Ansible Ad-Hoc 命令和 Playbook 的执行逻辑，是与 Ansible 交互的核心。
│   │   └── auth.py         # 认证管理器，实现了用户登录、登出和 JWT Token 的生成与验证。
│   └── requirements.txt    # Python 依赖清单，定义了后端服务所需的所有库。
├── frontend/               # 所有前端代码和资源
│   ├── static/             # 静态资源，如 CSS, JavaScript, 图片等
│   │   ├── css/style.css  # 主要的 CSS 样式文件，定义了整个应用的视觉风格、动画和响应式布局。
│   │   └── js/dashboard.js # 核心的 JavaScript 文件，处理所有前端交互、API 请求和动态内容渲染。
│   └── templates/          # HTML 模板目录
│       └── index.html      # 应用的单页面 HTML 骨架，所有内容都通过 JavaScript 动态加载到此页面。
├── ansible/                # Ansible 相关配置
│   ├── hosts               # 默认的主机清单(inventory)文件，用于存放和管理受控主机的连接信息。
│   └── playbooks/          # 存放 Ansible Playbook 的目录
│       ├── resource_monitor.yml # 用于收集主机资源的 Playbook。
│       └── network_scan.yml     # 用于检测网络信息的 Playbook。
├── docker/                 # Docker 相关配置
│   ├── Dockerfile          # 用于构建 Ansible-Dashboard 应用镜像的 Dockerfile。
│   └── nginx.conf          # Nginx 反向代理的配置文件，用于生产环境部署。
├── docker-compose.yml      # Docker Compose 编排文件，用于一键启动整个应用（包括主服务和测试容器）。
├── README.md               # 本项目说明文件。
└── BUGFIX_REPORT.md        # 记录了关键 Bug 的修复过程和解决方案的报告。
```

## 🚀 快速开始

仅需几分钟即可启动并运行 Ansible Dashboard。

### **环境要求**

- Docker >= 20.10
- Docker Compose >= 1.29
- 内存 >= 2GB
- 磁盘空间 >= 1GB

### **一键部署**

1. **克隆项目代码：**

   Bash

   ```
   git clone https://github.com/your-repo/ansible-dashboard.git
   cd ansible-dashboard
   ```

2. **启动服务：**

   Bash

   ```
   docker-compose up -d --build
   ```

3. **检查服务状态：**

   Bash

   ```
   docker-compose ps
   ```

### **访问地址**

- **Web 界面**: `http://192.168.20.9:5000` (或您服务器的 IP)
- **默认账号**: `admin`
- **默认密码**: `admin123`

## 📖 使用指南

### 1. **登录系统**

使用默认凭证 (`admin`/`admin123`) 登录。首次登录后，强烈建议修改密码。

### 2. **添加主机**

- 点击 **“添加主机”** 按钮。
- 填写主机的 IP 地址、用户名和密码。
- 将主机分配到一个组，然后点击“添加”。

### 3. **上传文件**

- 点击 **“文件上传”** 按钮。
- 拖拽文件或手动选择文件。
- 选择一个或多个目标主机。
- 指定远程存储路径（默认为 `/tmp/`）。
- 点击 **“开始上传”**。

### 4. **执行远程关机**

- 点击 **“远程关机”** 按钮。
- 选择目标主机。
- 设置延迟时间（0 为立即关机）。
- 确认操作。之后，仪表盘将自动监控主机并更新其状态。

## 🛠️ 关键 Bug 修复与功能增强

本项目在持续维护和改进。以下是一些已实现的关键优化：

- **智能关机指令处理**：修复了立即关机时因 SSH 连接突然中断而导致 API 误报失败的问题。后端现在能够智能分析指令输出，将连接中断识别为关机成功的标志，确保前端状态的准确性。
- **更稳健的连接与资源轮询**：修复了当资产清单中存在离线主机时，可能导致整个连接检测或资源监控 API 调用失败的问题。API 现在具有更强的容错性，即使部分主机无法访问，也能正确解析并返回有效结果，保证了仪表盘的稳定性和数据的准确性。

## 🔐 安全特性

- **身份认证**：基于 JWT (JSON Web Token) 的安全认证机制，支持会话超时自动登出。
- **文件安全**：实施了文件扩展名白名单、100MB 文件大小限制和安全的文件名处理，以防止注入攻击。
- **操作安全**：对于远程关机等高危操作，系统要求用户进行多次确认，以防止意外发生。

## 📊 API 端点

仪表盘由一个 RESTful API 驱动。

| **方法** | **端点**               | **描述**                   |
| -------- | ---------------------- | -------------------------- |
| `POST`   | `/api/login`           | 用户登录。                 |
| `POST`   | `/api/logout`          | 用户登出。                 |
| `GET`    | `/api/hosts`           | 获取所有主机的列表。       |
| `POST`   | `/api/hosts`           | 添加一个新主机。           |
| `GET`    | `/api/hosts/{ip}`      | 获取单个主机的详细信息。   |
| `PUT`    | `/api/hosts/{ip}`      | 更新一台主机的信息。       |
| `DELETE` | `/api/hosts/{ip}`      | 删除一台主机。             |
| `GET`    | `/api/ping`            | 检测所有主机的连通性。     |
| `GET`    | `/api/resources`       | 获取资源使用情况数据。     |
| `POST`   | `/api/upload`          | 上传文件到远程主机。       |
| `POST`   | `/api/shutdown`        | 远程关闭主机。             |
| `POST`   | `/api/cancel-shutdown` | 取消一个待处理的关机指令。 |

*(更多详情，请参阅 `backend/app.py` 文件)*

## 🤝 贡献指南

欢迎参与贡献！请遵循以下步骤：

1. Fork 本项目。
2. 创建一个新的功能分支 (`git checkout -b feature/AmazingFeature`)。
3. 提交您的更改 (`git commit -m 'Add some AmazingFeature'`)。
4. 将分支推送到您的 Fork (`git push origin feature/AmazingFeature`)。
5. 创建一个 Pull Request。

## 🙏 致谢

本项目的实现离不开以下这些优秀的开源项目：

- [Flask](https://flask.palletsprojects.com/)
- [Ansible](https://www.ansible.com/)
- [Chart.js](https://www.chartjs.org/)
- [FontAwesome](https://fontawesome.com/)

⭐ 如果这个项目对您有帮助，请给个 Star 支持一下！⭐